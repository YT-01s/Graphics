<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>3D 캐릭터 전시 UI</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="content">
        <div class="main-ui" id="three-area"></div>
        <div class="sidebar">
            <div class="description">
                <b>미술 그림, 석상<br>에 대한 설명</b>
            </div>
            <div class="quiz">
                <b>랜덤 문제</b><br>
                <input type="text" placeholder="정답 입력창">
                <button>정답 제출</button>
            </div>
        </div>
    </div>
    <div id="lockOverlay"
        style="position:absolute; top:0; left:0; right:0; bottom:0; background:#000000aa; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10;">
        클릭하여 시작
    </div>

    <div class="footer">
        <button class="toggle-3d"
            onclick="window.open('https://www.google.com/maps/@48.860225,2.3352583,3a,75y,13.54h,94t/data=!3m8!1e1!3m6!1sCIHM0ogKEICAgICk7LW1vAE!2e10!3e11!6shttps:%2F%2Flh3.googleusercontent.com%2Fgpms-cs-s%2FAB8u6HZTD86s_roXTIivi4wA0-YK8C9I9Nxqk3oijrMXuOcyXcvtG7qna5XA4XMV0UtIsKPeDogoM3eZFOHiJ5-ecnzbmPvOC8SkycEwTUVznELvTjQVtAiu3AE_CIvBvvGiJWvH8rGUZA%3Dw900-h600-k-no-pi-4-ya13.54-ro0-fo100!7i5376!8i2688?entry=ttu&g_ep=EgoyMDI1MDUyOC4wIKXMDSoASAFQAw%3D%3D')">
            작품 미술관 보러가기
        </button>
    </div>
    <!-- THREE.js & GLTF -->
    <script type="importmap">
        {
        "imports": {
            "three": "https://unpkg.com/three/build/three.module.js",
            "three/examples/": "https://unpkg.com/three/examples/jsm/"
        }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/examples/loaders/GLTFLoader.js';

        let scene, camera, renderer;
        const keys = {};
        let pitch = 0, yaw = 0;
        const moveSpeed = 0.1;
        const sensitivity = 0.002;

        let isMouseDown = false;
        let prevMouseX = 0;
        let prevMouseY = 0;

        const BOUNDS = {
            minX: -20,
            maxX: 30,
            minZ: -30,
            maxZ: 10,
        };

        init();
        animate();

        function init() {
            const container = document.getElementById("three-area");

            // 원본 배경 색상 유지
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 2, 0);
            camera.lookAt(new THREE.Vector3(0, 2, -1));

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // 조명
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 5);
            scene.add(dirLight);

            /*
            // 바닥 색상도 원본 유지
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshStandardMaterial({ color: 0xaaffaa })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            */
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load('./MonnaLisa.jpg', function (frontTexture) {
                const blackMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });

                const materials = [
                    blackMaterial, // right
                    blackMaterial, // left
                    blackMaterial, // top
                    blackMaterial, // bottom
                    new THREE.MeshStandardMaterial({ map: frontTexture, side: THREE.DoubleSide }), // ✅ front (+Z)
                    blackMaterial  // back
                ];

                const cube = new THREE.Mesh(new THREE.BoxGeometry(5, 5, 5), materials);
                cube.position.set(0, 2.5, -10); // 카메라가 보는 방향에 위치
                scene.add(cube);
            });

            const gltfLoader = new GLTFLoader();
            gltfLoader.load('./gallery.glb', (gltf) => {
                const gallery = gltf.scene;
                gallery.position.set(0, 1, 0); // 위치 조정 필요 시 수정
                gallery.scale.set(5, 5, 5);
                scene.add(gallery);
            }, undefined, (error) => {
                console.error('gallery.glb 로딩 실패:', error);
            });

            // 입력 이벤트
            window.addEventListener("keydown", (e) => keys[e.key.toLowerCase()] = true);
            window.addEventListener("keyup", (e) => keys[e.key.toLowerCase()] = false);

            // 반응형
            window.addEventListener("resize", () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        // 마우스 이벤트 등록
        window.addEventListener("mousedown", (e) => {
            isMouseDown = true;
            prevMouseX = e.clientX;
            prevMouseY = e.clientY;
        });

        window.addEventListener("mouseup", () => {
            isMouseDown = false;
        });

        window.addEventListener("mousemove", (e) => {
            if (!isMouseDown) return;

            const deltaX = e.clientX - prevMouseX;
            const deltaY = e.clientY - prevMouseY;
            prevMouseX = e.clientX;
            prevMouseY = e.clientY;

            yaw -= deltaX * sensitivity;
            pitch -= deltaY * sensitivity;

            // pitch 제한 (카메라 뒤집힘 방지)
            const limit = Math.PI / 2 - 0.01;
            pitch = Math.max(-limit, Math.min(limit, pitch));
        });


        function animate() {
            requestAnimationFrame(animate);

            // 회전 적용
            camera.rotation.set(pitch, yaw, 0);

            const direction = new THREE.Vector3();
            const front = new THREE.Vector3(-Math.sin(yaw), 0, -Math.cos(yaw));
            const right = new THREE.Vector3().crossVectors(front, camera.up);

            if (keys["w"]) direction.add(front);
            if (keys["s"]) direction.sub(front);
            if (keys["a"]) direction.sub(right);
            if (keys["d"]) direction.add(right);

            direction.normalize().multiplyScalar(moveSpeed);
            camera.position.add(direction);

            // ✅ 경계 체크 (XZ 평면 기준)
            camera.position.x = Math.max(BOUNDS.minX, Math.min(BOUNDS.maxX, camera.position.x));
            camera.position.z = Math.max(BOUNDS.minZ, Math.min(BOUNDS.maxZ, camera.position.z));

            renderer.render(scene, camera);
        }
    </script>
</body>

</html>